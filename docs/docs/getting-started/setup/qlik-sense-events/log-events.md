---
outline: deep
---

# Configuring Log Events

::: info Optional
These settings are optional.

If you don't do anything log events are turned off by default.
:::

## What's This?

Butler SOS log events are designed to be a replacement for the most important/useful aspects of Qlik Sense' log database, which was removed from Qlik Sense Enterprise on Windows in mid 2021.

The log events capture warnings, errors and fatals from the various QSEoW subsystems.  
These events used to be sent to the PostgreSQL logging database, most (but not all) are also sent to QSEoW's log files.

Using Butler SOS' log events is arguably even _better_ than getting the same information from log db:  
Log db had to be polled to detect new log events and this polling could realistically only be done every few minutes. It also put additional load on an often already struggling part of many QSEoW clusters.

With Butler SOS' log events concept the notifications are almost instantaneous.  
Errors and warnings show up in the Grafana or New Relic dashboards within seconds after taking place in QSEoW.

Log events rely on two things to work:

1. Settings in the Butler SOS config file.
2. Log appender XML files being deployed on the Sense servers where log events should be captured.

Both are described below.

::: tip Note
As of Butler SOS version 9.2, log events are captured in these QSEoW services:

- Engine
- Proxy
- Repository
- Scheduler

Support for additional modules is reasonably easy to add, please [create a ticket](https://github.com/ptarmiganlabs/butler-sos/issues/new?assignees=&labels=&template=feature_request.md&title=) if you believe some service should be added to the list above.
:::

## Tech Deep-Dive

The underlying mechanism is the same as described on the [user events page](/docs/getting-started/setup/qlik-sense-events/user-events#tech-deep-dive).

## Tagging of Data

### Categorizing Log Events

Log events can optionally be categorized by Butler SOS.  
The reason for categorizing log events is to make it easier to make sense of the potentially large number of log events that can be generated by a QSEoW cluster.

For example, if a QSEoW cluster creates 1000 warnings and errors per hour, it's difficult to know which warnings are important and which are not.  
By categorizing the messages, for example by the subsystem that generated them and/or what they refer to, it's easier to understand what's going on.

Possible ways of categorizing log events could be "access denied" issues, "user directory" issues, "app reload failed" issues, "general engine issues" etc.

Log events can be categorized in any number of ways, but the template config file contains a few examples.  
Specifically:

1. **Access denied issues**

   - Captures log events of severity WARN and ERROR.
   - Match log events against two filters:
     - Log message starts with "Access was denied for User:".
     - Log message contains "was denied for User".
   - Categorizes them by setting category tag `qs_log_category` to `access-denied`.

2. **AD issues**

   - Captures log events of severity WARN and ERROR.
   - Match log events against one filter:
     - Log message starts with "Duplicate entity with userId".
   - Categorizes them by setting category tag `qs_log_category` to `user-directory`.

3. **Qlik Sense service down**

   - Captures log events of severity WARN.
   - Match log events against two filters:
     - Log message starts with "Failed to request service alive response from".
     - Log message contains "Unable to connect to the remote server".
   - Categorizes them by setting category tag `qs_log_category` to `qs-service`.

4. **Reload task failed**

   - Captures log events of severity WARN and ERROR.
   - Match log events against four filters:
     - Log message starts with "Task finished with state FinishedFail".
     - Log message starts with "Task finished with state Error".
     - Log message ends with "Reload failed in Engine. Check engine or script logs.".
     - Log message starts with "Reload sequence was not successful (Result=False, Finished=True, Aborted=False) for engine connection with handle".
   - Categorizes them by setting category tag `qs_log_category` to `reload-failed`.

5. **Default rule** - If no rules match the log event, it will be categorized as `unknown`.
   - The default rule can be enabled/disabled in the config file via the `ruleDefault.enable` parameter.

::: tip Multiple Categories
It is possible to assign _one or more_ categories to a log event.
This provides flexibility in how you later create dashboards in for example Grafana or New Relic.
:::

::: info Drop Events
It is also possible to drop log events that match a certain pattern, for example if you are never interested in seeing them in Grafana or New Relic.  
This is done by setting the `action` parameter to `drop` in the config file, for that particular rule.
:::

### InfluxDB

The tags added to InfluxDB are described in the reference documentation for [log events](/docs/reference/available-metrics/influxdb#log-events).

Log categories are added as tags to InfluxDB datapoints.

### New Relic

The following attributes (which is New Relic lingo for tags) are added:

1. A core set of attributes are added to all log events. Note that some attributes will be empty for some/many log events.

   - `qs_ts_iso`: Event timestamp in ISO format.
   - `qs_ts_local`: Event timestamp in local (server) time zone.
   - `qs_log_source`: Which Sense service the event originated in, for example "qseow-proxy", "qseow-repository".
   - `qs_log_level`: Log level of the event. "WARN", "ERROR", or "FATAL".
   - `qs_host`: Host name of the Sense server the event originated at.
   - `qs_subsystem`: Which part of each Sense service the event originated in.
   - `qs_windows_user`: Name of the Windows user that's used to run the Windows service.
   - `qs_message`: Event message.
   - `qs_exception_message`: Additional information about the event.
   - `qs_user_full`: Full directory/user ID of the user the event is about.
   - `qs_user_directory`: User directory of the user the event is about.
   - `qs_user_id`: User ID of the user the event is about.
   - `qs_command`: What command (if any) caused the event.
   - `qs_result_code`: Result code as reported by Sense.
   - `qs_origin`: What kind of activity caused the event.
   - `qs_context`: Additional information about the event.
   - `qs_task_name`: Task name (if any) causing the event.
   - `qs_app_name`: App name (if any) causing the event.
   - `qs_task_id`: Task ID (if any) causing the event.
   - `qs_app_id`: App ID (if any) causing the event.
   - `qs_execution_id`: Execution ID as reported by Sense.
   - `qs_proxy_session_id`: Proxy session ID as reported by Sense.
   - `qs_engine_ts`: Engine timestamp (if any) associated with the event.
   - `qs_process_id`: Process ID of engine service.
   - `qs_engine_exe_version`: Version of engine service's EXE file.
   - `qs_server_started`: Timestamp when Sense engine service was started.
   - `qs_entry_type`: Entry type as reported by Sense.
   - `qs_session_id`: Session ID as reported by Sense.

2. Custom attributes defined in the Butler SOS config file's `Butler-SOS.logEvents.tags` section.

3. Custom attributes defined in the Butler SOS config file's `Butler-SOS.newRelic.event.attribute.static` section.

4. Dynamic attributes:
   - `butlerSosVersion`: Butler SOS version. Enabled by setting `Butler-SOS.newRelic.event.attribute.dynamic.butlerSosVersion.enable` to true.

::: warning Attribute Naming
Attributes defined further down in the list above will overwrite already defined attributes if their names match.  
To avoid problems you should make sure not to use already defined attributes.
:::

Log categories are currently NOT included in the data sent to New Relic.

## Settings in Main Config File

::: tip Template Config
The config snippet below comes from the [production_template.yaml](https://github.com/ptarmiganlabs/butler-sos/blob/master/src/config/production_template.yaml) file.

Being a template, it contains examples on how configuration _may_ be done - not necessarily how it _should_ be done.  
For example, the `env/DEV` and `foo/bar` tags are optional and can be changed to something else, or removed all together if not used.
:::

```yaml
Butler-SOS:
  ...
  ...
  # Log events are used to capture Sense warnings, errors and fatals in real time
  logEvents:
    udpServerConfig:
      serverHost: butler-sos.mycompany.net         # Host/IP where log event server will listen for events from Sense
      portLogEvents: 9996              # Port on which log event server will listen for events from Sense
    tags:
      # - name: env
      #   value: DEV
      # - name: foo
      #   value: bar
    source:
      engine:
        enable: false                  # Should log events from the engine service be handled?
      proxy:
        enable: false                  # Should log events from the proxy service be handled?
      repository:
        enable: false                  # Should log events from the repository service be handled?
      scheduler:
        enable: false                  # Should log events from the scheduler service be handled?
    categorise:                        # Take actions on log events based on their content
      enable: false
      rules:                           # Rules are used to match log events to filters
        # - description: Find access denied errors
        #   logLevel:                  # Log events of this Log level will be matched. WARN, ERROR, FATAL.
        #     - WARN
        #     - ERROR
        #   action: categorise         # Action to take on matched log events: categorise, drop
        #   category:                  # Category to assign to matched log events
        #     - name: qs_log_category
        #       value: access-denied
        #   filter:                    # Filter used to match log events. Case sensitive.
        #     - type: sw               # Type of filter. sw = starts with, ew = ends with, so = substring of
        #       value: "Access was denied for User:"
        #     - type: so
        #       value: was denied for User
        # - description: Find AD issues
        #   logLevel:
        #     - ERROR
        #     - WARN
        #   action: categorise
        #   category:
        #     - name: qs_log_category
        #       value: user-directory
        #   filter:
        #     - type: sw
        #       value: Duplicate entity with userId
        # - description: Qlik Sense service down
        #   logLevel:
        #     - WARN
        #   action: categorise
        #   category:
        #     - name: qs_log_category
        #       value: qs-service
        #   filter:
        #     - type: sw
        #       value: Failed to request service alive response from
        #     - type: so
        #       value: Unable to connect to the remote server
        # - description: Reload task failed
        #   logLevel:
        #     - WARN
        #     - ERROR
        #   action: categorise
        #   category:
        #     - name: qs_log_category
        #       value: reload-failed
        #   filter:
        #     - type: sw
        #       value: Task finished with state FinishedFail
        #     - type: sw
        #       value: Task finished with state Error
        #     - type: ew
        #       value: Reload failed in Engine. Check engine or script logs.
        #     - type: sw
        #       value: Reload sequence was not successful (Result=False, Finished=True, Aborted=False) for engine connection with handle
      ruleDefault:                     # Default rule to use if no other rules match the log event
        enable: true
        category:
          - name: qs_log_category
            value: unknown
    sendToMQTT:
      enable: false                    # Should log events be sent as MQTT messages?
      baseTopic: qliksense/logevent    # What topic should log events be forwarded to?
      postTo:
        baseTopic: true
        subsystemTopics: true          # Should log events be sent to subtopics corresponding to subsystems?
    sendToInfluxdb:
      enable: false                    # Should log events be stored in InfluxDB?
    sendToNewRelic:
      enable: false                    # Should log events be sent to New Relic?
      destinationAccount:
        # - First NR account
        # - Second NR account
      source:
        engine:
          enable: true                 # Should log events from the engine service be handled?
          logLevel:
            error: true                # Should error level log events be handled?
            warn: true                 # Should warning level log events be handled?
        proxy:
          enable: true
          logLevel:
            error: true
            warn: true
        repository:
          enable: true
          logLevel:
            error: true
            warn: true
        scheduler:
          enable: true
          logLevel:
            error: true
            warn: true
  ...
  ...
```

## Log Appender XML Files

Sample log appender files are available in the ZIP file available from the [download page](https://github.com/ptarmiganlabs/butler-sos/releases), in subfolders `engine/proxy/repository/scheduler` of the `config/log_appender_xml/` folder.

Note that the log appender files contain slightly different information for each Sense service (engine/proxy/repository/scheduler)!

Also keep in mind that the log appender files **must** be called `LocalLogConfig.xml` and placed in these directories on all Sense servers (assuming the default installation path of Qlik Sense):

- `C:\ProgramData\Qlik\Sense\Engine`
- `C:\ProgramData\Qlik\Sense\Proxy`
- `C:\ProgramData\Qlik\Sense\Repository`
- `C:\ProgramData\Qlik\Sense\Scheduler`

::: tip Selective Deployment
If you have more than one Sense server you strictly speaking don't _have_ to deploy log appenders to all servers.

If you are only interested in receiving log events from some servers and/or services (engine, proxy, repository, scheduler) - deploy the log appender files there.
:::
